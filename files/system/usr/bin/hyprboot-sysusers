#!/usr/bin/env bash
# Ensure system users/groups exist in /etc/passwd and /etc/shadow.
#
# After "bootc switch", /etc/passwd is preserved from the old OS and
# systemd-sysusers may be skipped (ConditionNeedsUpdate=/etc).
# This leaves the image's system users (sddm, rtkit, etc.) unresolved,
# breaking services like the display manager.
#
# All three commands are idempotent and fast when nothing is missing.

set -uo pipefail

# Fix stale gshadow entries from the old OS before sysusers runs,
# otherwise systemd-sysusers fails on groups already in gshadow.
grpconv || true
pwconv  || true

systemd-sysusers || true  # create users/groups from /usr/lib/sysusers.d/
pwconv  || true            # sync any new shadow entries
grpconv || true            # sync any new gshadow entries
